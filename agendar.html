<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agendar hora - Agenda Profesionales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Estilos para la agenda tipo tabla (como tu Excel) -->
  <style>
    .week {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .day {
      border-right: 1px solid #e5e7eb;
      min-height: 150px;
      padding: 10px 8px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .day:last-child {
      border-right: none;
    }
    .day-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }
    .day-date {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 8px;
    }
    .slots {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .slot {
      font-size: 0.9rem;
      text-align: center;
      padding: 4px 0;
      border-radius: 6px;
      border: 1px solid #bbf7d0;
      background: #ecfdf3;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    .slot:hover {
      background: #dcfce7;
      transform: translateY(-1px);
    }
    .slot.ocupado {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
      cursor: not-allowed;
    }

    @media (max-width: 900px) {
      .week {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 600px) {
      .week {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-3xl">
    <!-- CABECERA + BOT√ìN VOLVER -->
    <div class="flex items-start justify-between gap-3 mb-3">
      <div>
        <h1 id="tituloAgendar" class="text-2xl font-bold text-green-700 mb-1">
          Agendar hora
        </h1>
        <p id="subtituloAgendar" class="text-gray-600 text-sm">
          Elige un horario disponible y completa tus datos para confirmar la reserva.
        </p>
      </div>

      <button
        type="button"
        onclick="window.location.href='index.html'"
        class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
        ‚Üê Volver al inicio
      </button>
    </div>

    <!-- AGENDA (2 SEMANAS) -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2 gap-2">
        <button id="btnPrev"
                class="px-3 py-1 rounded border text-sm text-gray-600 hover:bg-gray-100 disabled:opacity-40 disabled:cursor-not-allowed">
          ‚Üê Semanas anteriores
        </button>

        <p id="rangoFechas" class="text-sm text-gray-600 text-center flex-1">
          <!-- 01-12-2025 al 14-12-2025 -->
        </p>

        <div class="flex items-center gap-2">
          <!-- Bot√≥n + popover personalizado para elegir mes -->
          <div class="relative inline-block">
            <button id="btnMes"
                    type="button"
                    class="px-3 py-1 rounded border text-sm text-gray-600 hover:bg-gray-100 bg-white">
              Elegir mes
            </button>

            <!-- POPUP DE MESES -->
            <div id="mesPopover"
                 class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-20 p-3">
              <div class="flex items-center justify-between mb-2">
                <button id="yearPrev"
                        type="button"
                        class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  ‚Äπ
                </button>
                <span id="yearLabel" class="font-semibold text-sm"></span>
                <button id="yearNext"
                        type="button"
                        class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  ‚Ä∫
                </button>
              </div>

              <div class="grid grid-cols-3 gap-1 text-xs">
                <button type="button" data-month="0"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Ene
                </button>
                <button type="button" data-month="1"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Feb
                </button>
                <button type="button" data-month="2"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Mar
                </button>
                <button type="button" data-month="3"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Abr
                </button>
                <button type="button" data-month="4"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  May
                </button>
                <button type="button" data-month="5"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Jun
                </button>
                <button type="button" data-month="6"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Jul
                </button>
                <button type="button" data-month="7"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Ago
                </button>
                <button type="button" data-month="8"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Sep
                </button>
                <button type="button" data-month="9"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Oct
                </button>
                <button type="button" data-month="10"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Nov
                </button>
                <button type="button" data-month="11"
                        class="px-2 py-1 rounded hover:bg-green-100">
                  Dic
                </button>
              </div>
            </div>
          </div>

          <button id="btnNext"
                  class="px-3 py-1 rounded border text-sm text-gray-600 hover:bg-gray-100">
            Siguientes 2 semanas ‚Üí
          </button>
        </div>
      </div>

      <h2 class="text-lg font-semibold mb-1">Horarios disponibles</h2>
      <p class="text-sm text-gray-500 mb-2">
        Revisa el rango mostrado y selecciona el horario que prefieras.
      </p>
      <div id="agendaSemanas"></div>
    </div>

    <!-- Input de fecha oculto por compatibilidad -->
    <input id="fecha" type="date" class="hidden" />

    <!-- Mensaje de estado -->
    <p id="mensaje" class="text-sm mt-2 text-center"></p>
  </div>

  <!-- MODAL FLOTANTE PARA RESERVA -->
  <div id="modalReserva"
       class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-5 relative mx-4">
      <!-- Bot√≥n X -->
      <button id="btnCerrarModal"
              type="button"
              class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl leading-none">
        √ó
      </button>

      <h2 class="text-lg font-semibold mb-1">Datos para la reserva</h2>
      <p class="text-xs text-gray-500 mb-3">
        Has seleccionado <span id="labelFechaSeleccionada" class="font-semibold"></span>.
      </p>

      <form id="formCita" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Nombre completo</label>
          <input name="nombreCliente" type="text" required
                 class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Tel√©fono de contacto</label>
          <input name="telefonoCliente" type="tel" required
                 class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Correo electr√≥nico</label>
          <input name="emailCliente" type="email" required
                 class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Comentario (opcional)</label>
          <textarea name="comentario" rows="2"
                    class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500"></textarea>
        </div>

        <!-- Tipo de pago -->
        <div>
          <span class="block text-sm font-medium mb-1">Tipo de pago</span>

          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2">
              <input type="radio" name="tipoPago" value="transferencia" checked />
              <span>Transferencia</span>
            </label>

            <label class="flex items-center gap-2">
              <input type="radio" name="tipoPago" value="efectivo" />
              <span>Efectivo</span>
            </label>
          </div>

          <!-- üîπ Datos para transferir (solo con "Transferencia") -->
          <div id="datosTransferencia"
               class="mt-2 text-xs text-gray-700 bg-green-50 border border-green-100 rounded-lg p-2 leading-snug">
            <p class="font-semibold text-green-800 mb-1">Datos para transferencia</p>
            <p><span class="font-semibold">Nombre:</span> Daniel Reyes Parra</p>
            <p><span class="font-semibold">RUT:</span> 19.204.129-5</p>
            <p><span class="font-semibold">Banco:</span> Banco Estado</p>
            <p><span class="font-semibold">Tipo de cuenta:</span> Cuenta RUT / Vista</p>
            <p><span class="font-semibold">N¬∞ de cuenta:</span> 19204129</p>
            <p class="mt-1 text-[11px] text-gray-500">
              * Monto sugerido: $15.000 ‚Äî Comentario: "Reserva agenda".
            </p>
          </div>
        </div>

        <!-- Comprobante (solo si transferencia) -->
        <div id="comprobanteWrapper">
          <label class="block text-sm font-medium mb-1">
            Comprobante de transferencia (imagen o PDF)
          </label>
          <input name="comprobante" type="file"
                 accept="image/*,.pdf"
                 class="w-full border rounded-lg px-3 py-2 bg-white" />
        </div>

        <!-- Info de la cita seleccionada -->
        <input type="hidden" name="fecha" id="inputFecha" />
        <input type="hidden" name="hora" id="inputHora" />

        <p id="resumenHora" class="text-sm text-gray-600 mt-1"></p>

        <!-- Bot√≥n -->
        <button type="submit"
                class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg w-full">
          Confirmar reserva
        </button>
      </form>
    </div>
  </div>

  <!-- Config global de API -->
  <script src="/js/config.js"></script>

  <script>
    const BASE_URL = window.API_BASE_URL;
    const fechaInput = document.getElementById("fecha");
    const formCita = document.getElementById("formCita");
    const inputFecha = document.getElementById("inputFecha");
    const inputHora = document.getElementById("inputHora");
    const resumenHora = document.getElementById("resumenHora");
    const mensaje = document.getElementById("mensaje");
    const comprobanteWrapper = document.getElementById("comprobanteWrapper");
    const datosTransferencia = document.getElementById("datosTransferencia");
    const tituloAgendar = document.getElementById("tituloAgendar");
    const subtituloAgendar = document.getElementById("subtituloAgendar");
    const agendaSemanas = document.getElementById("agendaSemanas");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const btnMes = document.getElementById("btnMes");
    const mesPopover = document.getElementById("mesPopover");
    const yearPrev = document.getElementById("yearPrev");
    const yearNext = document.getElementById("yearNext");
    const yearLabel = document.getElementById("yearLabel");
    const rangoFechas = document.getElementById("rangoFechas");

    const modalReserva = document.getElementById("modalReserva");
    const btnCerrarModal = document.getElementById("btnCerrarModal");
    const labelFechaSeleccionada = document.getElementById("labelFechaSeleccionada");

    const params = new URLSearchParams(window.location.search);
    const PROFESIONAL_ID = params.get("profesionalId");

    let horaSeleccionada = null;

    // 0 = bloque inicial (semana actual + siguiente), 1 = siguientes 2 semanas, etc.
    let offsetSemanas = 0;

    // Fecha de referencia (por defecto hoy en hora local).
    // Cuando eliges un mes, se cambia a 1 de ese mes.
    let fechaReferencia = new Date();
    let yearActivo = fechaReferencia.getFullYear();

    const DIAS_SEMANA = [
      "Domingo",
      "Lunes",
      "Martes",
      "Mi√©rcoles",
      "Jueves",
      "Viernes",
      "S√°bado",
    ];

    function formatearFechaISO(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`; // YYYY-MM-DD
    }

    function formatearFechaLabel(date) {
      const d = String(date.getDate()).padStart(2, "0");
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const y = date.getFullYear();
      return `${d}-${m}-${y}`; // DD-MM-YYYY
    }

    function obtenerLunesDeSemana(fechaBase) {
      const d = new Date(fechaBase);
      const day = d.getDay(); // 0 domingo, 1 lunes, ...
      const diff = day === 0 ? -6 : 1 - day; // mover al lunes
      d.setDate(d.getDate() + diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function actualizarEstadoBotones() {
      // No dejamos ir m√°s atr√°s que el bloque base (offsetSemanas 0)
      btnPrev.disabled = offsetSemanas === 0;
    }

    function actualizarYearLabel() {
      yearLabel.textContent = yearActivo;
    }

    function abrirModal() {
      modalReserva.classList.remove("hidden");
    }

    function cerrarModal() {
      modalReserva.classList.add("hidden");
    }

    // Cargar agenda de 2 semanas (lunes‚Äìdomingo x2) seg√∫n offsetSemanas y fechaReferencia
    async function cargarAgenda() {
      if (!PROFESIONAL_ID) return;

      agendaSemanas.innerHTML = "";
      horaSeleccionada = null;
      inputFecha.value = "";
      inputHora.value = "";
      resumenHora.textContent = "";
      mensaje.textContent = "";

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);

      const base = new Date(fechaReferencia);
      const lunesBase = obtenerLunesDeSemana(base);
      // desplazamiento en bloques de 14 d√≠as
      lunesBase.setDate(lunesBase.getDate() + offsetSemanas * 14);

      const dias = [];
      for (let i = 0; i < 14; i++) {
        const d = new Date(lunesBase);
        d.setDate(lunesBase.getDate() + i);
        d.setHours(0, 0, 0, 0);
        dias.push(d);
      }

      const semanas = [dias.slice(0, 7), dias.slice(7, 14)];

      // texto del rango arriba
      const fechaInicioLabel = formatearFechaLabel(dias[0]);
      const fechaFinLabel = formatearFechaLabel(dias[dias.length - 1]);
      rangoFechas.textContent = `${fechaInicioLabel} al ${fechaFinLabel}`;

      // ‚ö° 1 sola llamada al backend
      const desdeISO = formatearFechaISO(dias[0]);
      const hastaISO = formatearFechaISO(dias[dias.length - 1]);

      let mapaDisponibilidad = {};

      try {
        const res = await fetch(
          `${BASE_URL}/citas/disponible-rango?profesionalId=${PROFESIONAL_ID}&desde=${desdeISO}&hasta=${hastaISO}`
        );
        if (res.ok) {
          mapaDisponibilidad = await res.json();
        } else {
          console.error("Error disponible-rango:", await res.text());
          mapaDisponibilidad = {};
        }
      } catch (err) {
        console.error("Error llamando disponible-rango:", err);
        mapaDisponibilidad = {};
      }

      // Renderizar las 2 semanas
      for (const semana of semanas) {
        const section = document.createElement("section");
        section.className = "week";

        for (const dia of semana) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "day";

          const nombre = DIAS_SEMANA[dia.getDay()];
          const fechaISO = formatearFechaISO(dia);
          const fechaLabel = formatearFechaLabel(dia);

          const nombreEl = document.createElement("div");
          nombreEl.className = "day-name";
          nombreEl.textContent = nombre;

          const fechaEl = document.createElement("div");
          fechaEl.className = "day-date";
          fechaEl.textContent = fechaLabel;

          const slotsList = document.createElement("ul");
          slotsList.className = "slots";

          if (dia < hoy) {
            const li = document.createElement("li");
            li.className = "text-xs text-gray-400";
            li.textContent = "Fecha pasada";
            slotsList.appendChild(li);
          } else {
            const horas = mapaDisponibilidad[fechaISO] || [];

            if (horas.length > 0) {
              horas.forEach((horaStr) => {
                const li = document.createElement("li");
                li.className = "slot";
                li.textContent = horaStr;

                li.addEventListener("click", () => {
                  horaSeleccionada = horaStr;
                  inputFecha.value = fechaISO;
                  inputHora.value = horaStr;
                  const textoSeleccion = `${fechaLabel} a las ${horaStr}`;
                  resumenHora.textContent = `Has seleccionado el ${textoSeleccion}.`;
                  labelFechaSeleccionada.textContent = textoSeleccion;
                  abrirModal();
                });

                slotsList.appendChild(li);
              });
            } else {
              const li = document.createElement("li");
              li.className = "text-xs text-gray-400";
              li.textContent = "Sin horarios";
              slotsList.appendChild(li);
            }
          }

          dayDiv.appendChild(nombreEl);
          dayDiv.appendChild(fechaEl);
          dayDiv.appendChild(slotsList);
          section.appendChild(dayDiv);
        }

        agendaSemanas.appendChild(section);
      }

      actualizarEstadoBotones();
    }

    // ==========================
    //  INICIALIZACI√ìN
    // ==========================
    if (!PROFESIONAL_ID) {
      tituloAgendar.textContent = "Profesional no especificado";
      subtituloAgendar.textContent =
        "Vuelve a la p√°gina principal y elige un profesional para agendar.";
      fechaInput.disabled = true;
    } else {
      (async () => {
        try {
          const res = await fetch(`${BASE_URL}/profesionales/${PROFESIONAL_ID}`);
          if (!res.ok) throw new Error("No encontrado");
          const profesional = await res.json();

          let titulo = `Agendar hora con ${profesional.nombre}`;
          if (profesional.especialidad) {
            titulo += ` (${profesional.especialidad})`;
          }
          tituloAgendar.textContent = titulo;
          subtituloAgendar.textContent =
            "Elige un horario disponible y completa tus datos para confirmar la reserva.";

          fechaReferencia = new Date();
          yearActivo = fechaReferencia.getFullYear();
          offsetSemanas = 0;
          actualizarYearLabel();
          cargarAgenda();
        } catch (err) {
          console.error(err);
          tituloAgendar.textContent = "Profesional no encontrado";
          subtituloAgendar.textContent =
            "Verifica el enlace o vuelve a la p√°gina principal.";
          fechaInput.disabled = true;
        }
      })();
    }

    // Navegaci√≥n de semanas
    btnNext.addEventListener("click", () => {
      offsetSemanas++;
      cargarAgenda();
    });

    btnPrev.addEventListener("click", () => {
      if (offsetSemanas === 0) return;
      offsetSemanas--;
      cargarAgenda();
    });

    // POPUP DE MESES
    btnMes.addEventListener("click", (e) => {
      e.stopPropagation();
      if (mesPopover.classList.contains("hidden")) {
        yearActivo = fechaReferencia.getFullYear();
        actualizarYearLabel();
        mesPopover.classList.remove("hidden");
      } else {
        mesPopover.classList.add("hidden");
      }
    });

    yearPrev.addEventListener("click", (e) => {
      e.stopPropagation();
      yearActivo--;
      actualizarYearLabel();
    });

    yearNext.addEventListener("click", (e) => {
      e.stopPropagation();
      yearActivo++;
      actualizarYearLabel();
    });

    // Click en un mes
    mesPopover.querySelectorAll("[data-month]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const mes = parseInt(btn.dataset.month, 10); // 0‚Äì11
        fechaReferencia = new Date(yearActivo, mes, 1);
        offsetSemanas = 0;
        mesPopover.classList.add("hidden");
        cargarAgenda();
      });
    });

    // Cerrar popup si se hace click fuera
    document.addEventListener("click", (e) => {
      if (!mesPopover.contains(e.target) && !btnMes.contains(e.target)) {
        mesPopover.classList.add("hidden");
      }
    });

    // Cerrar modal al hacer click en X
    btnCerrarModal.addEventListener("click", () => {
      cerrarModal();
    });

    // Cerrar modal al hacer click fuera del cuadro
    modalReserva.addEventListener("click", (e) => {
      if (e.target === modalReserva) {
        cerrarModal();
      }
    });

    // Mostrar/ocultar comprobante seg√∫n tipo de pago
    formCita.tipoPago.forEach((radio) => {
      radio.addEventListener("change", () => {
        if (radio.value === "transferencia" && radio.checked) {
          comprobanteWrapper.classList.remove("hidden");
          datosTransferencia.classList.remove("hidden");
        } else if (radio.value === "efectivo" && radio.checked) {
          comprobanteWrapper.classList.add("hidden");
          datosTransferencia.classList.add("hidden");
        }
      });
    });

    // Enviar formulario de cita
    formCita.addEventListener("submit", async (e) => {
      e.preventDefault();
      mensaje.textContent = "";
      mensaje.className = "text-sm mt-2 text-center";

      if (!PROFESIONAL_ID) {
        mensaje.textContent = "Falta el profesional en la URL.";
        mensaje.classList.add("text-red-500");
        return;
      }

      if (!horaSeleccionada || !inputFecha.value) {
        mensaje.textContent = "Debes seleccionar un horario.";
        mensaje.classList.add("text-red-500");
        return;
      }

      const formData = new FormData(formCita);
      formData.append("profesionalId", PROFESIONAL_ID);

      try {
        const res = await fetch(`${BASE_URL}/citas`, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          console.error("Error API:", error);
          mensaje.textContent = "No se pudo agendar la cita. Intenta nuevamente.";
          mensaje.classList.add("text-red-500");
          return;
        }

        const data = await res.json();
        console.log("Cita creada:", data);

        mensaje.textContent = "‚úÖ ¬°Cita agendada con √©xito!";
        mensaje.classList.add("text-green-600");

        await cargarAgenda(); // recarga el mismo rango

        formCita.reset();
        comprobanteWrapper.classList.remove("hidden");
        datosTransferencia.classList.remove("hidden");
        cerrarModal();
      } catch (err) {
        console.error(err);
        mensaje.textContent = "Error de conexi√≥n. Intenta nuevamente.";
        mensaje.classList.add("text-red-500");
      }
    });
  </script>
</body>
</html>
