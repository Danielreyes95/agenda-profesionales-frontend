<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agendar hora - Agenda Profesionales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Estilos calendario tipo app m√≥vil -->
  <style>
    .cal-dia {
      border: none;
      background: transparent;
      padding: 0;
    }
    .cal-dia span.day-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      font-size: 0.85rem;
    }
    .cal-dia.has-agenda span.day-number {
      border: 2px solid #16a34a; /* verde */
      font-weight: 600;
      cursor: pointer;
    }
    .cal-dia.today span.day-number {
      border-color: #2563eb; /* azul para hoy */
    }
    .cal-dia.sin-agenda span.day-number {
      color: #9ca3af;
    }

    .bloque-horario {
      border-radius: 9999px;
      padding: 6px 14px;
      font-size: 0.85rem;
      border-width: 1px;
      border-style: solid;
    }
    .bloque-horario.disponible {
      background-color: #ecfdf3;
      border-color: #bbf7d0;
      color: #166534;
      cursor: pointer;
    }
    .bloque-horario.disponible:hover {
      background-color: #dcfce7;
    }
    .bloque-horario.reservado {
      background-color: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-3xl">
    <!-- CABECERA + BOT√ìN VOLVER -->
    <div class="flex items-start justify-between gap-3 mb-3">
      <div>
        <h1 id="tituloAgendar" class="text-2xl font-bold text-green-700 mb-1">
          Agendar hora
        </h1>
        <p id="subtituloAgendar" class="text-gray-600 text-sm">
          Elige un horario disponible y completa tus datos para confirmar la reserva.
        </p>
      </div>

      <button
        type="button"
        onclick="window.location.href='index.html'"
        class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
        ‚Üê Volver al inicio
      </button>
    </div>

    <!-- CALENDARIO MENSUAL -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2 gap-2">
        <button id="btnMesPrev"
                class="px-3 py-1 rounded border text-sm text-gray-600 hover:bg-gray-100">
          ‚Üê Mes anterior
        </button>

        <p id="labelMes" class="text-sm font-semibold text-gray-700 text-center flex-1">
          <!-- Mes / A√±o -->
        </p>

        <button id="btnMesNext"
                class="px-3 py-1 rounded border text-sm text-gray-600 hover:bg-gray-100">
          Mes siguiente ‚Üí
        </button>
      </div>

      <h2 class="text-lg font-semibold mb-1">Horarios disponibles</h2>
      <p class="text-sm text-gray-500 mb-2">
        Selecciona un d√≠a marcado en verde para ver los horarios. En verde los horarios <span class="font-semibold">Disponibles</span> y en rojo los <span class="font-semibold">Reservados</span>.
      </p>

      <!-- Encabezado d√≠as semana -->
      <div class="grid grid-cols-7 text-center text-xs font-semibold text-gray-600 mb-1">
        <div>Lun</div>
        <div>Mar</div>
        <div>Mi√©</div>
        <div>Jue</div>
        <div>Vie</div>
        <div>S√°b</div>
        <div>Dom</div>
      </div>

      <!-- Grid calendario -->
      <div id="gridCalendario"
           class="grid grid-cols-7 gap-1 min-h-[180px]">
        <!-- Se llena por JS -->
      </div>

      <!-- Horarios del d√≠a seleccionado -->
      <div id="horariosDiaWrapper" class="mt-4 hidden">
        <h3 id="labelFechaDiaSeleccionada"
            class="text-sm font-semibold text-gray-700 mb-2"></h3>
        <div id="listaHorarios" class="flex flex-wrap gap-2">
          <!-- botones de horarios por JS -->
        </div>
      </div>
    </div>

    <!-- Input de fecha oculto por compatibilidad -->
    <input id="fecha" type="date" class="hidden" />

    <!-- Mensaje de estado -->
    <p id="mensaje" class="text-sm mt-2 text-center"></p>
  </div>

  <!-- MODAL FLOTANTE PARA RESERVA -->
  <div id="modalReserva"
       class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-5 relative mx-4">
      <!-- Bot√≥n X -->
      <button id="btnCerrarModal"
              type="button"
              class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl leading-none">
        √ó
      </button>

      <h2 class="text-lg font-semibold mb-1">Datos para la reserva</h2>
      <p class="text-xs text-gray-500 mb-3">
        Has seleccionado <span id="labelFechaSeleccionada" class="font-semibold"></span>.
      </p>

      <form id="formCita" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Nombre completo</label>
          <input name="nombreCliente" type="text" required
                 class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Tel√©fono de contacto</label>
          <input name="telefonoCliente" type="tel" required
                 class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Correo electr√≥nico</label>
          <input name="emailCliente" type="email" required
                 class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Comentario (opcional)</label>
          <textarea name="comentario" rows="2"
                    class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500"></textarea>
        </div>

        <!-- Tipo de pago -->
        <div>
          <span class="block text-sm font-medium mb-1">Tipo de pago</span>

          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2">
              <input type="radio" name="tipoPago" value="transferencia" checked />
              <span>Transferencia</span>
            </label>

            <label class="flex items-center gap-2">
              <input type="radio" name="tipoPago" value="efectivo" />
              <span>Efectivo</span>
            </label>
          </div>

          <!-- Datos para transferir -->
          <div id="datosTransferencia"
               class="mt-2 text-xs text-gray-700 bg-green-50 border border-green-100 rounded-lg p-2 leading-snug">
            <p class="font-semibold text-green-800 mb-1">Datos para transferencia</p>
            <p><span class="font-semibold">Nombre:</span> Daniel Reyes Parra</p>
            <p><span class="font-semibold">RUT:</span> 19.204.129-5</p>
            <p><span class="font-semibold">Banco:</span> Banco Estado</p>
            <p><span class="font-semibold">Tipo de cuenta:</span> Cuenta RUT / Vista</p>
            <p><span class="font-semibold">N¬∞ de cuenta:</span> 19204129</p>
            <p class="mt-1 text-[11px] text-gray-500">
              * Monto sugerido: $15.000 ‚Äî Comentario: "Reserva agenda".
            </p>
          </div>
        </div>

        <!-- Comprobante (solo si transferencia) -->
        <div id="comprobanteWrapper">
          <label class="block text-sm font-medium mb-1">
            Comprobante de transferencia (imagen o PDF)
          </label>
          <input name="comprobante" type="file"
                 accept="image/*,.pdf"
                 class="w-full border rounded-lg px-3 py-2 bg-white" />
        </div>

        <!-- Info de la cita seleccionada -->
        <input type="hidden" name="fecha" id="inputFecha" />
        <input type="hidden" name="hora" id="inputHora" />

        <p id="resumenHora" class="text-sm text-gray-600 mt-1"></p>

        <!-- Bot√≥n -->
        <button type="submit"
                class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg w-full">
          Confirmar reserva
        </button>
      </form>
    </div>
  </div>
  
  <!-- Toast notificaci√≥n -->
  <div id="toastReserva"
       class="fixed top-4 right-4 z-50 hidden">
    <div id="toastReservaInner"
         class="flex items-start gap-3 px-4 py-3 rounded-xl shadow-lg bg-white border border-green-100">
      <div id="toastIcon"
           class="mt-0.5 flex h-7 w-7 items-center justify-center rounded-full bg-green-100">
        <span class="text-green-600 text-lg">‚úî</span>
      </div>
      <div>
        <p id="toastTitulo" class="text-sm font-semibold text-gray-900">
          Cita agendada
        </p>
        <p id="toastMensaje" class="text-sm text-gray-600">
          Tu cita fue agendada correctamente.
        </p>
      </div>
      <button id="toastCerrar"
              class="ml-2 text-gray-400 hover:text-gray-600 text-xl leading-none">
        √ó
      </button>
    </div>
  </div>

  <!-- Config global de API -->
  <script src="js/config.js"></script>

  <script>
    // üëâ Usamos API_BASE_URL (Render) con fallback a origin para desarrollo local
    const BASE_URL = window.API_BASE_URL || window.location.origin;
    console.log("API_BASE_URL (agendar) =", BASE_URL);

    const fechaInput = document.getElementById("fecha");
    const formCita = document.getElementById("formCita");
    const inputFecha = document.getElementById("inputFecha");
    const inputHora = document.getElementById("inputHora");
    const resumenHora = document.getElementById("resumenHora");
    const mensaje = document.getElementById("mensaje");
    const comprobanteWrapper = document.getElementById("comprobanteWrapper");
    const datosTransferencia = document.getElementById("datosTransferencia");
    const tituloAgendar = document.getElementById("tituloAgendar");
    const subtituloAgendar = document.getElementById("subtituloAgendar");

    const modalReserva = document.getElementById("modalReserva");
    const btnCerrarModal = document.getElementById("btnCerrarModal");
    const labelFechaSeleccionada = document.getElementById("labelFechaSeleccionada");

    const labelMes = document.getElementById("labelMes");
    const gridCalendario = document.getElementById("gridCalendario");
    const horariosDiaWrapper = document.getElementById("horariosDiaWrapper");
    const labelFechaDiaSeleccionada = document.getElementById("labelFechaDiaSeleccionada");
    const listaHorarios = document.getElementById("listaHorarios");
    const btnMesPrev = document.getElementById("btnMesPrev");
    const btnMesNext = document.getElementById("btnMesNext");

    const params = new URLSearchParams(window.location.search);
    const PROFESIONAL_ID = params.get("profesionalId");

    // ==== TOAST ====
    const toastReserva = document.getElementById("toastReserva");
    const toastReservaInner = document.getElementById("toastReservaInner");
    const toastTitulo = document.getElementById("toastTitulo");
    const toastMensaje = document.getElementById("toastMensaje");
    const toastIcon = document.getElementById("toastIcon");
    const toastCerrar = document.getElementById("toastCerrar");
    let toastTimeout = null;

    function showToastReserva(
      tipo = "success",
      mensajeTexto = "Tu cita fue agendada correctamente."
    ) {
      if (!toastReserva) {
        console.log("TOAST:", tipo, mensajeTexto);
        return;
      }

      if (tipo === "success") {
        toastReservaInner.className =
          "flex items-start gap-3 px-4 py-3 rounded-xl shadow-lg bg-white border border-green-100";
        toastIcon.className =
          "mt-0.5 flex h-7 w-7 items-center justify-center rounded-full bg-green-100";
        toastIcon.innerHTML = '<span class="text-green-600 text-lg">‚úî</span>';
        toastTitulo.textContent = "Cita agendada";
      } else if (tipo === "error") {
        toastReservaInner.className =
          "flex items-start gap-3 px-4 py-3 rounded-xl shadow-lg bg-white border border-red-100";
        toastIcon.className =
          "mt-0.5 flex h-7 w-7 items-center justify-center rounded-full bg-red-100";
        toastIcon.innerHTML = '<span class="text-red-600 text-lg">!</span>';
        toastTitulo.textContent = "Ocurri√≥ un problema";
      }

      toastMensaje.textContent = mensajeTexto;
      toastReserva.classList.remove("hidden");

      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        hideToastReserva();
      }, 4000);
    }

    function hideToastReserva() {
      if (!toastReserva) return;
      toastReserva.classList.add("hidden");
    }

    if (toastCerrar) {
      toastCerrar.addEventListener("click", hideToastReserva);
    }

    let horaSeleccionada = null;

    // Estado del mes mostrado
    const hoy = new Date();
    let mesActual = hoy.getMonth();      // 0‚Äì11
    let anioActual = hoy.getFullYear();  // 2025, etc.

    // mapaAgendaMes: { "YYYY-MM-DD": [ {hora, estado}, ... ] }
    let mapaAgendaMes = {};

    // ==========================
    //  UTILIDADES FECHAS
    // ==========================
    function formatearFechaISO(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`; // YYYY-MM-DD
    }

    function formatearFechaLabel(date) {
      const d = String(date.getDate()).padStart(2, "0");
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const y = date.getFullYear();
      return `${d}-${m}-${y}`; // DD-MM-YYYY
    }

    function formatearFechaLarga(yyyyMmDd) {
      const [y, m, d] = yyyyMmDd.split("-").map(Number);
      const fecha = new Date(y, m - 1, d);
      return fecha.toLocaleDateString("es-CL", {
        weekday: "long",
        day: "2-digit",
        month: "long",
        year: "numeric",
      });
    }

    // ==========================
    //  MODAL
    // ==========================
    function abrirModal() {
      modalReserva.classList.remove("hidden");
    }

    function cerrarModal() {
      modalReserva.classList.add("hidden");
    }

    btnCerrarModal.addEventListener("click", () => {
      cerrarModal();
    });

    modalReserva.addEventListener("click", (e) => {
      if (e.target === modalReserva) {
        cerrarModal();
      }
    });

    // ==========================
    //  CALENDARIO
    // ==========================
    btnMesPrev.addEventListener("click", () => {
      mesActual--;
      if (mesActual < 0) {
        mesActual = 11;
        anioActual--;
      }
      cargarAgendaMes();
    });

    btnMesNext.addEventListener("click", () => {
      mesActual++;
      if (mesActual > 11) {
        mesActual = 0;
        anioActual++;
      }
      cargarAgendaMes();
    });

    function renderCalendario() {
      const primerDia = new Date(anioActual, mesActual, 1);
      const ultimoDia = new Date(anioActual, mesActual + 1, 0);

      labelMes.textContent = primerDia.toLocaleDateString("es-CL", {
        month: "long",
        year: "numeric",
      });

      gridCalendario.innerHTML = "";

      // Lunes como primer d√≠a de la semana
      const indiceInicio = (primerDia.getDay() + 6) % 7;

      // Celdas vac√≠as antes del primer d√≠a
      for (let i = 0; i < indiceInicio; i++) {
        const empty = document.createElement("div");
        empty.className = "h-8";
        gridCalendario.appendChild(empty);
      }

      const hoyKey = formatearFechaISO(hoy);

      // D√≠as del mes
      for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const fechaObj = new Date(anioActual, mesActual, dia);
        const fechaKey = formatearFechaISO(fechaObj);

        const cell = document.createElement("div");
        cell.className = "flex justify-center py-1";

        const btn = document.createElement("button");
        btn.className = "cal-dia";

        const span = document.createElement("span");
        span.className = "day-number";
        span.textContent = dia;

        btn.appendChild(span);

        const slots = mapaAgendaMes[fechaKey] || [];

        if (slots.length > 0) {
          btn.classList.add("has-agenda");
          btn.addEventListener("click", () => seleccionarDia(fechaKey));
        } else {
          btn.classList.add("sin-agenda");
          btn.disabled = true;
        }

        if (fechaKey === hoyKey) {
          btn.classList.add("today");
        }

        cell.appendChild(btn);
        gridCalendario.appendChild(cell);
      }
    }

    function seleccionarDia(fechaKey) {
      const slots = mapaAgendaMes[fechaKey] || [];
      labelFechaDiaSeleccionada.textContent = formatearFechaLarga(fechaKey);
      listaHorarios.innerHTML = "";

      if (slots.length === 0) {
        listaHorarios.innerHTML =
          "<p class='text-sm text-gray-500'>Sin horarios para este d√≠a.</p>";
      } else {
        // ordenar por hora
        const ordenados = [...slots].sort((a, b) =>
          a.hora.localeCompare(b.hora)
        );

        ordenados.forEach((slot) => {
          const estado = (slot.estado || "disponible").toLowerCase();

          const btn = document.createElement("button");
          btn.className = "bloque-horario";
          btn.textContent =
            estado === "reservado"
              ? `${slot.hora} - Reservado`
              : `${slot.hora} - Disponible`;

          if (estado === "reservado") {
            btn.classList.add("reservado");
            btn.disabled = true;
          } else {
            btn.classList.add("disponible");
            btn.addEventListener("click", () => {
              horaSeleccionada = slot.hora;
              inputFecha.value = fechaKey;
              inputHora.value = slot.hora;

              const textoSeleccion = `${formatearFechaLarga(
                fechaKey
              )} a las ${slot.hora}`;
              resumenHora.textContent = `Has seleccionado el ${textoSeleccion}.`;
              labelFechaSeleccionada.textContent = textoSeleccion;

              abrirModal();
            });
          }

          listaHorarios.appendChild(btn);
        });
      }

      horariosDiaWrapper.classList.remove("hidden");
    }

    // ==========================
    //  CARGAR AGENDA MES
    // ==========================
    async function cargarAgendaMes() {
      if (!PROFESIONAL_ID) return;

      mensaje.textContent = "";
      horariosDiaWrapper.classList.add("hidden");
      listaHorarios.innerHTML = "";
      horaSeleccionada = null;
      inputFecha.value = "";
      inputHora.value = "";
      resumenHora.textContent = "";

      const primerDia = new Date(anioActual, mesActual, 1);
      const ultimoDia = new Date(anioActual, mesActual + 1, 0);

      const desdeISO = formatearFechaISO(primerDia);
      const hastaISO = formatearFechaISO(ultimoDia);

      let raw = {};

      try {
        const res = await fetch(
          `${BASE_URL}/citas/disponible-rango?profesionalId=${PROFESIONAL_ID}&desde=${desdeISO}&hasta=${hastaISO}`
        );
        if (res.ok) {
          raw = await res.json();
        } else {
          console.error("Error disponible-rango:", await res.text());
          raw = {};
        }
      } catch (err) {
        console.error("Error llamando disponible-rango:", err);
        raw = {};
      }

      // Normalizar:
      // - si viene { fecha: ["13:00","15:00"] } => todas "disponible"
      // - si viene { fecha: [{hora:"13:00",estado:"reservado"}, ...] } => respeta estado
      mapaAgendaMes = {};
      Object.entries(raw || {}).forEach(([fecha, arr]) => {
        if (!Array.isArray(arr)) return;
        mapaAgendaMes[fecha] = arr.map((item) => {
          if (typeof item === "string") {
            return { hora: item, estado: "disponible" };
          } else {
            return {
              hora: item.hora || String(item),
              estado: item.estado || "disponible",
            };
          }
        });
      });

      renderCalendario();
    }

    // ==========================
    //  INICIALIZACI√ìN
    // ==========================
    if (!PROFESIONAL_ID) {
      tituloAgendar.textContent = "Profesional no especificado";
      subtituloAgendar.textContent =
        "Vuelve a la p√°gina principal y elige un profesional para agendar.";
      fechaInput.disabled = true;
    } else {
      (async () => {
        try {
          const res = await fetch(`${BASE_URL}/profesionales/${PROFESIONAL_ID}`);
          if (!res.ok) throw new Error("No encontrado");
          const profesional = await res.json();

          let titulo = `Agendar hora con ${profesional.nombre}`;
          if (profesional.especialidad) {
            titulo += ` (${profesional.especialidad})`;
          }
          tituloAgendar.textContent = titulo;
          subtituloAgendar.textContent =
            "Elige un horario disponible y completa tus datos para confirmar la reserva.";

          mesActual = hoy.getMonth();
          anioActual = hoy.getFullYear();
          await cargarAgendaMes();
        } catch (err) {
          console.error(err);
          tituloAgendar.textContent = "Profesional no encontrado";
          subtituloAgendar.textContent =
            "Verifica el enlace o vuelve a la p√°gina principal.";
          fechaInput.disabled = true;
        }
      })();
    }

    // Mostrar/ocultar comprobante seg√∫n tipo de pago
    formCita.tipoPago.forEach((radio) => {
      radio.addEventListener("change", () => {
        if (radio.value === "transferencia" && radio.checked) {
          comprobanteWrapper.classList.remove("hidden");
          datosTransferencia.classList.remove("hidden");
        } else if (radio.value === "efectivo" && radio.checked) {
          comprobanteWrapper.classList.add("hidden");
          datosTransferencia.classList.add("hidden");
        }
      });
    });

    // Enviar formulario de cita
    formCita.addEventListener("submit", async (e) => {
      e.preventDefault();
      mensaje.textContent = "";
      mensaje.className = "text-sm mt-2 text-center";

      if (!PROFESIONAL_ID) {
        const msg = "Falta el profesional en la URL.";
        mensaje.textContent = msg;
        mensaje.classList.add("text-red-500");
        showToastReserva("error", msg);
        return;
      }

      if (!horaSeleccionada || !inputFecha.value) {
        const msg = "Debes seleccionar un horario.";
        mensaje.textContent = msg;
        mensaje.classList.add("text-red-500");
        showToastReserva("error", msg);
        return;
      }

      const formData = new FormData(formCita);
      formData.append("profesionalId", PROFESIONAL_ID);

      try {
        const res = await fetch(`${BASE_URL}/citas`, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          let errorMsg = "No se pudo agendar la cita. Intenta nuevamente.";
          try {
            const error = await res.json();
            console.error("Error API:", error);
            if (error && error.message) {
              errorMsg = Array.isArray(error.message)
                ? error.message.join(", ")
                : error.message;
            }
          } catch (_) {
            console.error("No se pudo parsear el error como JSON");
          }

          mensaje.textContent = errorMsg;
          mensaje.className = "text-sm mt-2 text-center text-red-500";
          showToastReserva("error", errorMsg);
          return;
        }

        const data = await res.json();
        console.log("Cita creada:", data);

        mensaje.textContent = "‚úÖ ¬°Cita agendada con √©xito!";

        mensaje.className =
          "text-sm mt-2 text-center text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2 max-w-xl mx-auto";

        showToastReserva(
          "success",
          "Tu cita fue agendada correctamente. Revisa tu correo de confirmaci√≥n."
        );

        await cargarAgendaMes(); // recarga el mes

        formCita.reset();
        comprobanteWrapper.classList.remove("hidden");
        datosTransferencia.classList.remove("hidden");
        cerrarModal();
      } catch (err) {
        console.error(err);
        const msg = "Error de conexi√≥n. Intenta nuevamente.";
        mensaje.textContent = msg;
        mensaje.className = "text-sm mt-2 text-center text-red-500";
        showToastReserva("error", msg);
      }
    });
  </script>
</body>
</html>
